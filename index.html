<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师版判断题答题卡系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(135deg, #4a8cff, #3a6fcc);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        /* 向导样式 */
        .wizard {
            display: flex;
            min-height: 600px;
        }
        
        .wizard-steps {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }
        
        .wizard-content {
            flex: 1;
            padding: 30px;
        }
        
        .step-item {
            padding: 15px 25px;
            margin-bottom: 10px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .step-item.active {
            background: rgba(74, 140, 255, 0.1);
            border-left-color: #4a8cff;
            color: #4a8cff;
            font-weight: bold;
        }
        
        .step-item.completed {
            color: #4CAF50;
        }
        
        .step-item.disabled {
            color: #9e9e9e;
            cursor: not-allowed;
        }
        
        .step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #e0e0e0;
            border-radius: 50%;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .step-item.active .step-number {
            background: #4a8cff;
            color: white;
        }
        
        .step-item.completed .step-number {
            background: #4CAF50;
            color: white;
        }
        
        .step-panel {
            display: none;
        }
        
        .step-panel.active {
            display: block;
        }
        
        .step-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4a8cff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-description {
            margin-bottom: 25px;
            color: #666;
            line-height: 1.6;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a8cff;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #4a8cff;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 140, 255, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 14px 32px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a8cff, #3a6fcc);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 140, 255, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 140, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00c853, #009624);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 200, 83, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 200, 83, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #5f6368;
            border: 1px solid #dadce0;
        }
        
        .btn-secondary:hover {
            background: #f1f3f4;
        }
        
        .btn:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .step-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        /* 答题卡区域 */
        .instructions {
            background-color: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            position: relative;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin: 15px 0;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .answer-sheet {
            padding: 25px 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
        }
        
        .question {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        
        .question.active {
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .question-number {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: #4a8cff;
            display: flex;
            align-items: center;
        }
        
        .question-number::after {
            content: "";
            flex: 1;
            height: 1px;
            background: #e0e0e0;
            margin-left: 10px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
        }
        
        .option-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .option-label {
            font-weight: bold;
            color: #4a8cff;
            font-size: 14px;
        }
        
        .option-buttons {
            display: flex;
            gap: 10px;
        }
        
        .option-btn {
            flex: 1;
            height: 40px;
            border: 2px solid #4a8cff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            background-color: white;
            color: #4a8cff;
            transition: background-color 0.1s ease, color 0.1s ease;
        }
        
        .option-btn:hover {
            background-color: #e8f0fe;
        }
        
        .option-btn.selected {
            background-color: #4a8cff;
            color: white;
        }
        
        .option-btn.active {
            border: 2px solid #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            background-color: #FFF9C4;
            color: #333;
        }
        
        .option-btn.locked {
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* 正确答案样式 */
        .option-btn.correct {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        /* 错误答案样式 */
        .option-btn.incorrect {
            background-color: #f5f5f5;
            color: #999;
            border-color: #ccc;
            cursor: not-allowed;
        }
        
        /* 空格选项样式 - 蓝色 */
        .option-btn.correct-space {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        /* 只读模式下的正确选项样式 */
        .option-btn.student-correct {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
            cursor: default;
            pointer-events: none;
        }
        
        /* 只读模式下的错误选项样式 */
        .option-btn.student-incorrect {
            background-color: #f44336;
            color: white;
            border-color: #f44336;
            cursor: default;
            pointer-events: none;
        }
        
        /* 键盘输入提示 */
        .keyboard-hint {
            background-color: #FFF3CD;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            color: #856404;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .keyboard-hint kbd {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* 当前输入位置指示器 */
        .current-position {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        /* 键盘快捷键提示 */
        .keyboard-shortcuts {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 表格样式 */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
        }
        
        .results-table th {
            background: #4a8cff;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .results-table tr:hover {
            background: #e8f0fe;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-btn {
            background: #4a8cff;
            color: white;
        }
        
        .edit-btn {
            background: #ff9800;
            color: white;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        
        /* 导入导出按钮 */
        .import-export-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        
        /* 响应式设计 */
        @media (max-width: 992px) {
            .answer-sheet {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .wizard {
                flex-direction: column;
            }
            
            .wizard-steps {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .step-items {
                display: flex;
                overflow-x: auto;
            }
            
            .step-item {
                min-width: 180px;
                border-left: none;
                border-bottom: 4px solid transparent;
            }
            
            .step-item.active {
                border-left-color: transparent;
                border-bottom-color: #4a8cff;
            }
            
            .import-export-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .answer-sheet {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .answer-sheet {
                grid-template-columns: 1fr;
            }
            
            .step-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .step-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 警告和确认框 */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .progress-info {
            margin: 15px 0;
            font-weight: 500;
            color: #4a8cff;
        }
        
        /* 统计信息 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4a8cff;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* 锁定提示 */
        .locked-message {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            color: #1565c0;
            font-weight: 500;
            text-align: center;
        }
        
        /* 锁定表单样式 */
        .locked-form input, .locked-form select {
            background-color: #f5f5f5;
            border-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        /* 只读模式样式 */
        .view-mode .form-group input, 
        .view-mode .form-group select {
            background-color: #f5f5f5;
            border-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .view-mode .option-btn {
            cursor: default;
            pointer-events: none;
        }
        
        .view-mode .option-btn:hover {
            background-color: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>教师版判断题答题卡系统</h1>
            <p class="subtitle">通过四个简单步骤完成试卷设置、答案录入和成绩分析</p>
        </header>
        
        <div class="wizard">
            <div class="wizard-steps">
                <div class="step-items">
                    <div class="step-item active" data-step="1">
                        <span class="step-number">1</span>
                        <span class="step-text">编辑试卷类型</span>
                    </div>
                    <div class="step-item" data-step="2">
                        <span class="step-number">2</span>
                        <span class="step-text">录入试题答案</span>
                    </div>
                    <div class="step-item" data-step="3">
                        <span class="step-number">3</span>
                        <span class="step-text">录入学生答案</span>
                    </div>
                    <div class="step-item" data-step="4">
                        <span class="step-number">4</span>
                        <span class="step-text">成绩分析</span>
                    </div>
                </div>
                
                <div class="import-export-buttons">
                    <button class="btn btn-warning" id="importData">
                        <i class="fas fa-file-import"></i> 导入数据
                    </button>
                    <button class="btn btn-success" id="exportData">
                        <i class="fas fa-file-export"></i> 导出数据
                    </button>
                </div>
            </div>
            
            <div class="wizard-content">
                <!-- 步骤1：编辑试卷类型 -->
                <div class="step-panel active" id="step1">
                    <h2 class="step-title">
                        <i class="fas fa-file-alt"></i> 编辑试卷类型
                    </h2>
                    <p class="step-description">
                        请填写试卷的基本信息，包括试卷编号、试卷名称和试题数量。
                    </p>
                    
                    <div class="form-group">
                        <label for="examId">试卷编号</label>
                        <input type="text" id="examId" placeholder="请输入试卷编号" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                    </div>
                    
                    <div class="form-group">
                        <label for="examName">试卷名称</label>
                        <input type="text" id="examName" placeholder="请输入试卷名称">
                    </div>
                    
                    <div class="form-group">
                        <label for="questionCount">试题数量</label>
                        <input type="number" id="questionCount" min="1" max="200" value="80">
                    </div>
                    
                    <div class="step-actions">
                        <div></div> <!-- 占位 -->
                        <button class="btn btn-primary" id="nextToStep2">
                            下一步 <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 步骤2：录入试题答案 -->
                <div class="step-panel" id="step2">
                    <h2 class="step-title">
                        <i class="fas fa-edit"></i> 录入试题答案
                    </h2>
                    <p class="step-description">
                        请设置所有题目的正确答案。每道题包含4个独立选项，每个选项都需要选择正确（T）或错误（F）。
                        按空格键可以跳过当前选项（设置为空格），空格选项表示学生只要填涂就正确。
                    </p>
                    
                    <div class="instructions">
                        <div class="keyboard-shortcuts">
                            <i class="fas fa-keyboard"></i> 空格键跳过当前选项
                        </div>
                        
                        <div class="keyboard-hint">
                            <i class="fas fa-keyboard"></i> 
                            <span>键盘操作提示：按 <kbd>T</kbd> 或 <kbd>F</kbd> 键输入答案，按 <kbd>Backspace</kbd> 删除上一个答案，按 <kbd>Space</kbd> 跳过当前选项（设置为空格）</span>
                        </div>
                        
                        <div class="progress-info" id="answerProgress">
                            总题数: 80
                        </div>
                        
                        <div class="locked-message" id="lockedMessage" style="display: none;">
                            <i class="fas fa-lock"></i> 标准答案已锁定，不可修改
                        </div>
                    </div>
                    
                    <div class="answer-sheet" id="answerSheet">
                        <!-- 题目将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="step-actions">
                        <button class="btn btn-secondary" id="backToStep1">
                            <i class="fas fa-arrow-left"></i> 上一步
                        </button>
                        <button class="btn btn-primary" id="confirmAnswers">
                            确认答案 <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-success" id="nextToStep3" style="display: none;">
                            下一步 <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 步骤3：录入学生答案 -->
                <div class="step-panel" id="step3">
                    <h2 class="step-title">
                        <i class="fas fa-user-graduate"></i> 录入学生答案
                    </h2>
                    <p class="step-description">
                        请填写学生信息并录入答案。年级只能选择"高X"或"初X"。
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentName">学生姓名</label>
                            <input type="text" id="studentName" placeholder="请输入学生姓名">
                        </div>
                        <div class="form-group">
                            <label for="studentGrade">年级</label>
                            <select id="studentGrade">
                                <option value="">请选择年级</option>
                                <option value="高一">高一</option>
                                <option value="高二">高二</option>
                                <option value="高三">高三</option>
                                <option value="初一">初一</option>
                                <option value="初二">初二</option>
                                <option value="初三">初三</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="studentClass">班级</label>
                            <input type="text" id="studentClass" placeholder="例如：3" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                        </div>
                    </div>
                    
                    <div class="instructions">
                        <div class="keyboard-shortcuts">
                            <i class="fas fa-keyboard"></i> 空格键跳过当前选项
                        </div>
                        
                        <div class="keyboard-hint">
                            <i class="fas fa-keyboard"></i> 
                            <span>键盘操作提示：按 <kbd>T</kbd> 或 <kbd>F</kbd> 键输入答案，按 <kbd>Backspace</kbd> 删除上一个答案，按 <kbd>Space</kbd> 跳过当前选项</span>
                        </div>
                        
                        <div class="progress-info" id="studentProgress">
                            完成进度: 0/0
                        </div>
                    </div>
                    
                    <div class="answer-sheet" id="studentAnswerSheet">
                        <!-- 题目将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="step-actions">
                        <button class="btn btn-secondary" id="backToStep2">
                            <i class="fas fa-arrow-left"></i> 上一步
                        </button>
                        <div id="studentActions">
                            <button class="btn btn-success" id="submitStudent">
                                提交学生答案 <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="btn btn-primary" id="viewResults">
                                查看结果 <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                        <div id="viewActions" style="display: none;">
                            <button class="btn btn-warning" id="downloadStudentDetail">
                                下载得分详情 <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-primary" id="backToResults">
                                返回成绩分析 <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 步骤4：成绩分析 -->
                <div class="step-panel" id="step4">
                    <h2 class="step-title">
                        <i class="fas fa-chart-bar"></i> 成绩分析
                    </h2>
                    <p class="step-description">
                        查看学生成绩统计，可以下载单个学生得分详情或整个班级的报表。
                    </p>
                    
                    <div class="stats-container" id="statsContainer">
                        <!-- 统计信息将通过JavaScript动态生成 -->
                    </div>
                    
                    <h3 id="tableTitle">答题情况</h3>
                    
                    <div class="step-actions">
                        <button class="btn btn-secondary" id="backToStep3">
                            <i class="fas fa-arrow-left"></i> 上一步
                        </button>
                        <button class="btn btn-warning" id="downloadClassReport" disabled>
                            下载班级报表 <i class="fas fa-download"></i>
                        </button>
                    </div>
                    
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>年级班级</th>
                                <th>学生姓名</th>
                                <th>成绩</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- 学生记录将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                    
                    <div class="no-data" id="noDataMessage" style="display: none;">
                        <i class="fas fa-info-circle"></i> 暂无学生数据，请在步骤3中添加学生答案
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 当前输入位置指示器 -->
    <div class="current-position" id="currentPosition" style="display: none;">
        第1题 A选项
    </div>

    <script>
        // 初始化变量
        let currentStep = 1;
        let examData = {
            id: '',
            name: '',
            questionCount: 80
        };
        let correctAnswers = [];
        let studentAnswersList = []; // 存储所有学生答案
        let currentStudentIndex = -1; // 当前正在编辑的学生索引，-1表示新增
        let isCorrectAnswersLocked = false; // 标记标准答案是否已锁定
        let isStep1Locked = false; // 标记步骤1是否已锁定
        let isViewMode = false; // 标记是否处于查看详情模式
        
        // 键盘导航相关变量
        let currentQuestion = 0;
        let currentOption = 0;
        let allQuestionsAnswered = false;
        
        // 步骤2的键盘导航相关变量
        let currentCorrectQuestion = 0;
        let currentCorrectOption = 0;
        let allCorrectQuestionsAnswered = false;
        
        // DOM元素
        const stepItems = document.querySelectorAll('.step-item');
        const stepPanels = document.querySelectorAll('.step-panel');
        const answerSheet = document.getElementById('answerSheet');
        const studentAnswerSheet = document.getElementById('studentAnswerSheet');
        const answerProgress = document.getElementById('answerProgress');
        const studentProgress = document.getElementById('studentProgress');
        const currentPosition = document.getElementById('currentPosition');
        const resultsBody = document.getElementById('resultsBody');
        const statsContainer = document.getElementById('statsContainer');
        const tableTitle = document.getElementById('tableTitle');
        const noDataMessage = document.getElementById('noDataMessage');
        const downloadClassReport = document.getElementById('downloadClassReport');
        const lockedMessage = document.getElementById('lockedMessage');
        const confirmAnswersBtn = document.getElementById('confirmAnswers');
        const nextToStep3Btn = document.getElementById('nextToStep3');
        const studentActions = document.getElementById('studentActions');
        const viewActions = document.getElementById('viewActions');
        const downloadStudentDetail = document.getElementById('downloadStudentDetail');
        const backToResults = document.getElementById('backToResults');
        
        // 检查步骤3是否有未提交的数据
        function hasUnsavedDataInStep3() {
            // 获取当前学生答案
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                if (studentAnswersList.length === 0) {
                    return false;
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            // 检查学生信息是否填写
            const name = document.getElementById('studentName').value.trim();
            const grade = document.getElementById('studentGrade').value;
            const cls = document.getElementById('studentClass').value.trim();
            
            // 如果学生信息有填写，则视为有未提交数据
            if (name || grade || cls) {
                return true;
            }
            
            // 检查是否有答案被选择
            const hasAnswers = currentStudent.answers.some(question => 
                question.some(option => option !== null)
            );
            
            return hasAnswers;
        }
        
        // 清空步骤3的未提交数据
        function clearUnsavedDataInStep3() {
            // 重置表单
            document.getElementById('studentName').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('studentClass').value = '';
            
            // 重置UI
            studentAnswerSheet.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 重置当前学生答案数组
            if (currentStudentIndex >= 0) {
                // 编辑模式，恢复原始数据
                const student = studentAnswersList[currentStudentIndex];
                for (let i = 0; i < examData.questionCount; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (student.answers[i][j] !== null) {
                            const button = document.querySelector(`#student-question-${i+1} .option-btn[data-option="${j}"][data-value="${student.answers[i][j]}"]`);
                            if (button) {
                                button.classList.add('selected');
                            }
                        }
                    }
                }
            } else {
                // 新增模式，清空临时数据
                if (studentAnswersList.length > 0 && studentAnswersList[studentAnswersList.length - 1].name === '') {
                    studentAnswersList.pop();
                }
            }
            
            // 重置导航
            currentQuestion = 0;
            currentOption = 0;
            currentStudentIndex = -1;
            allQuestionsAnswered = false;
            updateCurrentSelection();
            updateStudentProgress();
        }
        
        // 步骤切换函数
        function goToStep(step) {
            // 检查步骤跳转条件
            if (step === 2 && !isStep1Locked) {
                alert('请先完成步骤1：编辑试卷类型！');
                return;
            }
            
            if (step === 3 && !isCorrectAnswersLocked) {
                alert('请先完成步骤2：录入并确认试题答案！');
                return;
            }
            
            if (step === 4) {
                // 过滤掉未提交的学生记录（姓名为空的记录）
                const submittedStudents = studentAnswersList.filter(student => student.name.trim() !== '');
                if (submittedStudents.length === 0) {
                    alert('请先完成步骤3：至少录入一个学生答案！');
                    return;
                }
            }
            
            // 如果当前在步骤3且有未提交的数据，提示用户
            if (currentStep === 3 && step !== 3 && hasUnsavedDataInStep3() && !isViewMode) {
                if (!confirm('确定离开这一步骤吗？您未提交的数据会被清空。')) {
                    return;
                }
                clearUnsavedDataInStep3();
            }
            
            // 更新步骤指示器
            stepItems.forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.step) === step) {
                    item.classList.add('active');
                }
            });
            
            // 更新步骤面板
            stepPanels.forEach(panel => {
                panel.classList.remove('active');
                if (panel.id === `step${step}`) {
                    panel.classList.add('active');
                }
            });
            
            currentStep = step;
            
            // 控制位置指示器显示 - 步骤1和4完全隐藏
            if (step === 1 || step === 4) {
                currentPosition.style.display = 'none';
            } else {
                currentPosition.style.display = 'block';
            }
            
            // 如果进入步骤2，生成题目
            if (step === 2) {
                generateQuestions(examData.questionCount, answerSheet, true);
                updateAnswerProgress();
                // 重置步骤2的导航状态
                currentCorrectQuestion = 0;
                currentCorrectOption = 0;
                allCorrectQuestionsAnswered = false;
                updateCorrectCurrentSelection();
                
                // 如果答案已锁定，禁用所有选项按钮
                if (isCorrectAnswersLocked) {
                    lockCorrectAnswers();
                }
            }
            
            // 如果进入步骤3，生成学生答题卡
            if (step === 3) {
                // 重置当前学生答案
                generateQuestions(examData.questionCount, studentAnswerSheet, false);
                updateStudentProgress();
                // 重置步骤3的导航状态
                if (currentStudentIndex >= 0) {
                    // 编辑模式：跳转到最后一道题D选项
                    currentQuestion = examData.questionCount - 1;
                    currentOption = 3;
                } else {
                    // 新增模式：从第一题A选项开始
                    currentQuestion = 0;
                    currentOption = 0;
                }
                allQuestionsAnswered = false;
                updateCurrentSelection();
                
                // 如果是编辑模式，移除高亮
                if (currentStudentIndex >= 0) {
                    removeAllHighlights();
                }
                
                // 如果是查看模式，应用颜色标记
                if (isViewMode) {
                    applyAnswerColors();
                }
            }
            
            // 如果进入步骤4，更新成绩分析
            if (step === 4) {
                updateResultsTable();
                updateStats();
                // 确保步骤4隐藏位置指示器
                currentPosition.style.display = 'none';
            }
        }
        
        // 锁定步骤1表单
        function lockStep1Form() {
            document.getElementById('examId').disabled = true;
            document.getElementById('examName').disabled = true;
            document.getElementById('questionCount').disabled = true;
            
            // 添加锁定样式
            const step1Form = document.getElementById('step1');
            step1Form.classList.add('locked-form');
        }
        
        // 锁定标准答案
        function lockCorrectAnswers() {
            // 显示锁定消息
            lockedMessage.style.display = 'block';
            
            // 显示正确答案，空格选项显示为特殊样式
            for (let i = 0; i < correctAnswers.length; i++) {
                for (let j = 0; j < 4; j++) {
                    const correctValue = correctAnswers[i][j];
                    const tButton = document.querySelector(`#correct-question-${i+1} .option-btn[data-option="${j}"][data-value="T"]`);
                    const fButton = document.querySelector(`#correct-question-${i+1} .option-btn[data-option="${j}"][data-value="F"]`);
                    
                    if (correctValue === null) {
                        // 空格选项：两个按钮都显示为特殊颜色（蓝色），表示任意填涂都正确
                        if (tButton) {
                            tButton.classList.add('correct-space');
                            tButton.classList.remove('selected');
                            tButton.classList.add('locked');
                            tButton.style.cursor = 'not-allowed';
                            tButton.onclick = null;
                        }
                        if (fButton) {
                            fButton.classList.add('correct-space');
                            fButton.classList.remove('selected');
                            fButton.classList.add('locked');
                            fButton.style.cursor = 'not-allowed';
                            fButton.onclick = null;
                        }
                    } else {
                        // 正常答案：正确答案显示绿色，错误答案显示灰色
                        const correctButton = document.querySelector(`#correct-question-${i+1} .option-btn[data-option="${j}"][data-value="${correctValue}"]`);
                        const wrongValue = correctValue === 'T' ? 'F' : 'T';
                        const wrongButton = document.querySelector(`#correct-question-${i+1} .option-btn[data-option="${j}"][data-value="${wrongValue}"]`);
                        
                        // 正确答案标记为绿色
                        if (correctButton) {
                            correctButton.classList.add('correct');
                            correctButton.classList.remove('selected');
                            correctButton.classList.add('locked');
                            correctButton.style.cursor = 'not-allowed';
                            correctButton.onclick = null;
                        }
                        
                        // 错误答案标记为灰色
                        if (wrongButton) {
                            wrongButton.classList.add('incorrect');
                            wrongButton.classList.remove('selected');
                            wrongButton.classList.add('locked');
                            wrongButton.style.cursor = 'not-allowed';
                            wrongButton.onclick = null;
                        }
                    }
                }
            }
            
            // 隐藏当前输入位置指示器
            currentPosition.style.display = 'none';
            
            // 切换按钮显示
            confirmAnswersBtn.style.display = 'none';
            nextToStep3Btn.style.display = 'inline-flex';
        }
        
        // 生成题目
        function generateQuestions(count, container, isCorrectAnswer) {
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.id = `${isCorrectAnswer ? 'correct' : 'student'}-question-${i}`;
                questionDiv.innerHTML = `
                    <div class="question-number">${i}.</div>
                    <div class="options-grid">
                        <div class="option-row">
                            <div class="option-label">A</div>
                            <div class="option-buttons">
                                <div class="option-btn" data-question="${i}" data-option="0" data-value="T">T</div>
                                <div class="option-btn" data-question="${i}" data-option="0" data-value="F">F</div>
                            </div>
                        </div>
                        <div class="option-row">
                            <div class="option-label">B</div>
                            <div class="option-buttons">
                                <div class="option-btn" data-question="${i}" data-option="1" data-value="T">T</div>
                                <div class="option-btn" data-question="${i}" data-option="1" data-value="F">F</div>
                            </div>
                        </div>
                        <div class="option-row">
                            <div class="option-label">C</div>
                            <div class="option-buttons">
                                <div class="option-btn" data-question="${i}" data-option="2" data-value="T">T</div>
                                <div class="option-btn" data-question="${i}" data-option="2" data-value="F">F</div>
                            </div>
                        </div>
                        <div class="option-row">
                            <div class="option-label">D</div>
                            <div class="option-buttons">
                                <div class="option-btn" data-question="${i}" data-option="3" data-value="T">T</div>
                                <div class="option-btn" data-question="${i}" data-option="3" data-value="F">F</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            }
            
            // 添加选项事件监听
            if (!isViewMode) {
                container.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (isCorrectAnswer) {
                            if (!isCorrectAnswersLocked) {
                                handleCorrectAnswerClick.call(this);
                            }
                        } else {
                            handleStudentAnswerClick.call(this);
                        }
                    });
                });
            }
            
            // 初始化答案数组
            if (isCorrectAnswer && correctAnswers.length === 0) {
                correctAnswers = Array(count).fill().map(() => Array(4).fill(null));
            }
            
            // 如果编辑已有学生答案，填充数据
            if (!isCorrectAnswer && currentStudentIndex >= 0) {
                const student = studentAnswersList[currentStudentIndex];
                for (let i = 0; i < count; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (student.answers[i][j] !== null) {
                            const button = document.querySelector(`#student-question-${i+1} .option-btn[data-option="${j}"][data-value="${student.answers[i][j]}"]`);
                            if (button) {
                                button.classList.add('selected');
                            }
                        }
                    }
                }
                updateStudentProgress();
            }
            
            // 设置初始选中状态
            if (!isCorrectAnswer) {
                updateCurrentSelection();
            } else {
                updateCorrectCurrentSelection();
            }
        }
        
        // 处理正确答案点击
        function handleCorrectAnswerClick() {
            const question = parseInt(this.dataset.question);
            const option = parseInt(this.dataset.option);
            const value = this.dataset.value;
            
            // 移除同选项的其他选择
            const parentButtons = this.parentElement;
            parentButtons.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
            });
            
            // 选中当前选项
            this.classList.add('selected');
            correctAnswers[question-1][option] = value;
            
            updateAnswerProgress();
            updateCorrectAllQuestionsAnswered();
            
            // 移动到下一个未作答选项
            findNextUnansweredCorrectOption();
        }
        
        // 处理学生答案点击
        function handleStudentAnswerClick() {
            const question = parseInt(this.dataset.question);
            const option = parseInt(this.dataset.option);
            const value = this.dataset.value;
            
            // 更新当前选中位置
            currentQuestion = question - 1;
            currentOption = option;
            updateCurrentSelection();
            
            // 获取当前学生答案
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                // 新增学生，创建临时答案数组
                if (studentAnswersList.length === 0 || studentAnswersList[studentAnswersList.length - 1].name !== '') {
                    // 创建新的临时学生记录
                    studentAnswersList.push({
                        name: '',
                        grade: '',
                        class: '',
                        answers: Array(examData.questionCount).fill().map(() => Array(4).fill(null))
                    });
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            // 检查当前选项是否已选中
            if (currentStudent.answers[currentQuestion][currentOption] === value) {
                // 取消选择
                this.classList.remove('selected');
                currentStudent.answers[currentQuestion][currentOption] = null;
                updateStudentProgress();
                checkAllQuestionsAnswered();
            } else {
                // 移除同选项的其他选择
                const parentButtons = this.parentElement;
                parentButtons.querySelectorAll('.option-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // 选中当前选项
                this.classList.add('selected');
                currentStudent.answers[currentQuestion][currentOption] = value;
                
                updateStudentProgress();
                checkAllQuestionsAnswered();
                
                // 移动到下一个未作答选项
                findNextUnansweredOption();
            }
        }
        
        // 应用答案颜色标记（只读模式）
        function applyAnswerColors() {
            if (currentStudentIndex < 0) return;
            
            const student = studentAnswersList[currentStudentIndex];
            
            for (let i = 0; i < examData.questionCount; i++) {
                for (let j = 0; j < 4; j++) {
                    const studentValue = student.answers[i][j];
                    const correctValue = correctAnswers[i][j];
                    
                    // 学生未填涂的选项不显示颜色
                    if (studentValue === null) continue;
                    
                    const button = document.querySelector(`#student-question-${i+1} .option-btn[data-option="${j}"][data-value="${studentValue}"]`);
                    if (!button) continue;
                    
                    // 如果教师设置的是空格，学生填涂的选项显示绿色
                    if (correctValue === null) {
                        button.classList.add('student-correct');
                    } else {
                        // 教师设置了具体答案，学生答案正确显示绿色，错误显示红色
                        if (studentValue === correctValue) {
                            button.classList.add('student-correct');
                        } else {
                            button.classList.add('student-incorrect');
                        }
                    }
                    
                    // 在只读模式下，锁定所有选项按钮
                    button.classList.add('locked');
                }
            }
        }
        
        // 更新步骤2当前选中状态
        function updateCorrectCurrentSelection() {
            // 如果所有题目都已答完，不显示高亮
            if (allCorrectQuestionsAnswered || isCorrectAnswersLocked) {
                removeCorrectHighlights();
                return;
            }
            
            // 移除所有现有的活动状态
            document.querySelectorAll('#answerSheet .question.active').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('#answerSheet .option-btn.active').forEach(el => {
                el.classList.remove('active');
            });
            
            // 设置当前题目和选项为活动状态
            const currentQuestionEl = document.getElementById(`correct-question-${currentCorrectQuestion + 1}`);
            if (currentQuestionEl) {
                currentQuestionEl.classList.add('active');
                
                // 滚动到可见区域
                currentQuestionEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // 设置当前选项的两个按钮都为活动状态
                const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentCorrectOption}"]`);
                optionButtons.forEach(btn => {
                    btn.classList.add('active');
                });
            }
            
            // 更新位置指示器
            updateCorrectPositionIndicator();
        }
        
        // 更新步骤2位置指示器
        function updateCorrectPositionIndicator() {
            const optionLabels = ['A', 'B', 'C', 'D'];
            currentPosition.textContent = `第${currentCorrectQuestion + 1}题 ${optionLabels[currentCorrectOption]}选项`;
        }
        
        // 更新步骤3当前选中状态
        function updateCurrentSelection() {
            // 如果所有题目都已答完，不显示高亮
            if (allQuestionsAnswered) {
                removeAllHighlights();
                return;
            }
            
            // 移除所有现有的活动状态
            document.querySelectorAll('#studentAnswerSheet .question.active').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('#studentAnswerSheet .option-btn.active').forEach(el => {
                el.classList.remove('active');
            });
            
            // 设置当前题目和选项为活动状态
            const currentQuestionEl = document.getElementById(`student-question-${currentQuestion + 1}`);
            if (currentQuestionEl) {
                currentQuestionEl.classList.add('active');
                
                // 滚动到可见区域
                currentQuestionEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // 设置当前选项的两个按钮都为活动状态
                const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentOption}"]`);
                optionButtons.forEach(btn => {
                    btn.classList.add('active');
                });
            }
            
            // 更新位置指示器
            updatePositionIndicator();
        }
        
        // 更新步骤3位置指示器
        function updatePositionIndicator() {
            const optionLabels = ['A', 'B', 'C', 'D'];
            currentPosition.textContent = `第${currentQuestion + 1}题 ${optionLabels[currentOption]}选项`;
        }
        
        // 移除步骤2高亮样式
        function removeCorrectHighlights() {
            document.querySelectorAll('#answerSheet .question.active').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('#answerSheet .option-btn.active').forEach(el => {
                el.classList.remove('active');
            });
            currentPosition.style.display = 'none';
        }
        
        // 移除步骤3高亮样式
        function removeAllHighlights() {
            document.querySelectorAll('#studentAnswerSheet .question.active').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('#studentAnswerSheet .option-btn.active').forEach(el => {
                el.classList.remove('active');
            });
            currentPosition.style.display = 'none';
        }
        
        // 处理键盘输入
        function handleKeyDown(e) {
            // 如果在步骤1，忽略所有键盘输入
            if (currentStep === 1) return;
            
            // 如果在步骤2且已锁定，忽略键盘输入
            if (currentStep === 2 && isCorrectAnswersLocked) return;
            
            // 如果在步骤2且所有题目已答完，忽略TF输入
            if (currentStep === 2 && allCorrectQuestionsAnswered && 
                (e.key.toUpperCase() === 'T' || e.key.toUpperCase() === 'F')) {
                return;
            }
            
            // 如果在步骤3且所有题目已答完，忽略TF输入
            if (currentStep === 3 && allQuestionsAnswered && 
                (e.key.toUpperCase() === 'T' || e.key.toUpperCase() === 'F')) {
                return;
            }
            
            // 检查是否在输入框中
            const activeElement = document.activeElement;
            if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA') {
                // 如果在输入框中，只处理Esc键
                if (e.key === 'Escape') {
                    activeElement.blur();
                }
                // 其他按键在输入框中正常处理
                return;
            }
            
            if (currentStep === 2 && !isCorrectAnswersLocked) {
                handleKeyDownForCorrect(e);
            } else if (currentStep === 3 && !isViewMode) {
                handleKeyDownForStudent(e);
            }
        }
        
        // 处理步骤2键盘输入
        function handleKeyDownForCorrect(e) {
            // 处理T、F、Backspace和Space键
            if (e.key.toUpperCase() === 'T' || e.key.toUpperCase() === 'F' || e.key === 'Backspace' || e.key === ' ') {
                e.preventDefault();
                
                if (e.key === 'Backspace') {
                    handleCorrectBackspace();
                } else if (e.key === ' ') {
                    skipCurrentCorrectOption();
                } else {
                    handleCorrectAnswerInput(e.key.toUpperCase());
                }
            }
        }
        
        // 处理步骤3键盘输入
        function handleKeyDownForStudent(e) {
            // 处理T、F、Backspace和Space键
            if (e.key.toUpperCase() === 'T' || e.key.toUpperCase() === 'F' || e.key === 'Backspace' || e.key === ' ') {
                e.preventDefault();
                
                if (e.key === 'Backspace') {
                    handleBackspace();
                } else if (e.key === ' ') {
                    skipCurrentOption();
                } else {
                    handleAnswerInput(e.key.toUpperCase());
                }
            }
        }
        
        // 跳过步骤2当前选项（设置为空格）
        function skipCurrentCorrectOption() {
            // 将当前选项设置为null（空格）
            correctAnswers[currentCorrectQuestion][currentCorrectOption] = null;
            
            // 更新UI
            const currentQuestionEl = document.getElementById(`correct-question-${currentCorrectQuestion + 1}`);
            if (currentQuestionEl) {
                // 移除同选项的其他选择
                const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentCorrectOption}"]`);
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            updateAnswerProgress();
            updateCorrectAllQuestionsAnswered();
            findNextUnansweredCorrectOption();
        }
        
        // 跳过步骤3当前选项
        function skipCurrentOption() {
            findNextUnansweredOption();
        }
        
        // 处理步骤2答案输入
        function handleCorrectAnswerInput(value) {
            // 设置当前选项的答案
            correctAnswers[currentCorrectQuestion][currentCorrectOption] = value;
            
            // 更新UI
            const currentQuestionEl = document.getElementById(`correct-question-${currentCorrectQuestion + 1}`);
            if (currentQuestionEl) {
                // 移除同选项的其他选择
                const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentCorrectOption}"]`);
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // 选中当前输入的选项
                const selectedBtn = currentQuestionEl.querySelector(`.option-btn[data-option="${currentCorrectOption}"][data-value="${value}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
            }
            
            updateAnswerProgress();
            updateCorrectAllQuestionsAnswered();
            findNextUnansweredCorrectOption();
        }
        
        // 处理步骤3答案输入
        function handleAnswerInput(value) {
            // 获取当前学生答案
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                // 新增学生，创建临时答案数组
                if (studentAnswersList.length === 0 || studentAnswersList[studentAnswersList.length - 1].name !== '') {
                    // 创建新的临时学生记录
                    studentAnswersList.push({
                        name: '',
                        grade: '',
                        class: '',
                        answers: Array(examData.questionCount).fill().map(() => Array(4).fill(null))
                    });
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            // 设置当前选项的答案
            currentStudent.answers[currentQuestion][currentOption] = value;
            
            // 更新UI
            const currentQuestionEl = document.getElementById(`student-question-${currentQuestion + 1}`);
            if (currentQuestionEl) {
                // 移除同选项的其他选择
                const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentOption}"]`);
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // 选中当前输入的选项
                const selectedBtn = currentQuestionEl.querySelector(`.option-btn[data-option="${currentOption}"][data-value="${value}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
            }
            
            updateStudentProgress();
            checkAllQuestionsAnswered();
            findNextUnansweredOption();
        }
        
        // 查找步骤2下一个未作答的选项
        function findNextUnansweredCorrectOption() {
            // 保存当前的位置
            let startQ = currentCorrectQuestion;
            let startO = currentCorrectOption;
            
            // 从当前选项的下一个开始查找
            let found = false;
            
            // 先检查当前题目的剩余选项
            for (let o = currentCorrectOption + 1; o < 4; o++) {
                if (correctAnswers[currentCorrectQuestion][o] === null) {
                    currentCorrectOption = o;
                    found = true;
                    break;
                }
            }
            
            // 如果当前题目没有未作答的选项，检查后续题目
            if (!found) {
                for (let q = currentCorrectQuestion + 1; q < examData.questionCount; q++) {
                    for (let o = 0; o < 4; o++) {
                        if (correctAnswers[q][o] === null) {
                            currentCorrectQuestion = q;
                            currentCorrectOption = o;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
            }
            
            // 如果后面没有未作答的选项，检查前面的题目
            if (!found) {
                for (let q = 0; q < startQ; q++) {
                    for (let o = 0; o < 4; o++) {
                        if (correctAnswers[q][o] === null) {
                            currentCorrectQuestion = q;
                            currentCorrectOption = o;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
            }
            
            // 如果还是没有找到，检查当前题目前面的选项
            if (!found) {
                for (let o = 0; o < startO; o++) {
                    if (correctAnswers[currentCorrectQuestion][o] === null) {
                        currentCorrectOption = o;
                        found = true;
                        break;
                    }
                }
            }
            
            // 如果所有选项都已作答，停留在当前位置
            if (!found) {
                currentCorrectQuestion = startQ;
                currentCorrectOption = startO;
            }
            
            updateCorrectCurrentSelection();
        }
        
        // 查找步骤3下一个未作答的选项
        function findNextUnansweredOption() {
            // 获取当前学生答案
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                if (studentAnswersList.length === 0) {
                    // 如果没有学生记录，直接返回
                    return;
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            // 保存当前的位置
            let startQ = currentQuestion;
            let startO = currentOption;
            
            // 从当前选项的下一个开始查找
            let found = false;
            
            // 先检查当前题目的剩余选项
            for (let o = currentOption + 1; o < 4; o++) {
                if (currentStudent.answers[currentQuestion][o] === null) {
                    currentOption = o;
                    found = true;
                    break;
                }
            }
            
            // 如果当前题目没有未作答的选项，检查后续题目
            if (!found) {
                for (let q = currentQuestion + 1; q < examData.questionCount; q++) {
                    for (let o = 0; o < 4; o++) {
                        if (currentStudent.answers[q][o] === null) {
                            currentQuestion = q;
                            currentOption = o;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
            }
            
            // 如果后面没有未作答的选项，检查前面的题目
            if (!found) {
                for (let q = 0; q < startQ; q++) {
                    for (let o = 0; o < 4; o++) {
                        if (currentStudent.answers[q][o] === null) {
                            currentQuestion = q;
                            currentOption = o;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
            }
            
            // 如果还是没有找到，检查当前题目前面的选项
            if (!found) {
                for (let o = 0; o < startO; o++) {
                    if (currentStudent.answers[currentQuestion][o] === null) {
                        currentOption = o;
                        found = true;
                        break;
                    }
                }
            }
            
            // 如果所有选项都已作答，停留在当前位置
            if (!found) {
                currentQuestion = startQ;
                currentOption = startO;
            }
            
            updateCurrentSelection();
        }
        
        // 检查步骤2是否所有题目都已答完
        function updateCorrectAllQuestionsAnswered() {
            allCorrectQuestionsAnswered = correctAnswers.every(question => 
                question.every(option => option !== null)
            );
            
            if (allCorrectQuestionsAnswered) {
                removeCorrectHighlights();
                currentPosition.style.display = 'none';
            } else {
                currentPosition.style.display = 'block';
            }
        }
        
        // 检查步骤3是否所有题目都已答完
        function checkAllQuestionsAnswered() {
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                if (studentAnswersList.length === 0) {
                    allQuestionsAnswered = false;
                    return;
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            allQuestionsAnswered = currentStudent.answers.every(question => 
                question.every(option => option !== null)
            );
            
            if (allQuestionsAnswered) {
                removeAllHighlights();
                currentPosition.style.display = 'none';
            } else {
                currentPosition.style.display = 'block';
            }
        }
        
        // 处理步骤2退格键
        function handleCorrectBackspace() {
            // 如果所有题目都已答完，重新启用高亮
            if (allCorrectQuestionsAnswered) {
                allCorrectQuestionsAnswered = false;
                updateCorrectCurrentSelection();
            }
            
            // 如果当前选项有答案，先清除它
            if (correctAnswers[currentCorrectQuestion][currentCorrectOption] !== null) {
                correctAnswers[currentCorrectQuestion][currentCorrectOption] = null;
                
                // 更新UI
                const currentQuestionEl = document.getElementById(`correct-question-${currentCorrectQuestion + 1}`);
                if (currentQuestionEl) {
                    const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentCorrectOption}"]`);
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
                
                updateAnswerProgress();
                updateCorrectAllQuestionsAnswered();
                return; // 清除后停留在当前位置
            }
            
            // 如果当前选项没有答案，则移动到上一个选项
            moveToPreviousCorrectOption();
            
            // 如果上一个选项有答案，清除它
            if (correctAnswers[currentCorrectQuestion][currentCorrectOption] !== null) {
                correctAnswers[currentCorrectQuestion][currentCorrectOption] = null;
                
                // 更新UI
                const currentQuestionEl = document.getElementById(`correct-question-${currentCorrectQuestion + 1}`);
                if (currentQuestionEl) {
                    const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentCorrectOption}"]`);
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
                
                updateAnswerProgress();
                updateCorrectAllQuestionsAnswered();
            }
        }
        
        // 处理步骤3退格键
        function handleBackspace() {
            // 如果所有题目都已答完，重新启用高亮
            if (allQuestionsAnswered) {
                allQuestionsAnswered = false;
                updateCurrentSelection();
            }
            
            // 获取当前学生答案
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                if (studentAnswersList.length === 0) {
                    return;
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            // 如果当前选项有答案，先清除它
            if (currentStudent.answers[currentQuestion][currentOption] !== null) {
                currentStudent.answers[currentQuestion][currentOption] = null;
                
                // 更新UI
                const currentQuestionEl = document.getElementById(`student-question-${currentQuestion + 1}`);
                if (currentQuestionEl) {
                    const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentOption}"]`);
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
                
                updateStudentProgress();
                checkAllQuestionsAnswered();
                return; // 清除后停留在当前位置
            }
            
            // 如果当前选项没有答案，则移动到上一个选项
            moveToPreviousOption();
            
            // 如果上一个选项有答案，清除它
            if (currentStudent.answers[currentQuestion][currentOption] !== null) {
                currentStudent.answers[currentQuestion][currentOption] = null;
                
                // 更新UI
                const currentQuestionEl = document.getElementById(`student-question-${currentQuestion + 1}`);
                if (currentQuestionEl) {
                    const optionButtons = currentQuestionEl.querySelectorAll(`.option-btn[data-option="${currentOption}"]`);
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
                
                updateStudentProgress();
                checkAllQuestionsAnswered();
            }
        }
        
        // 移动到步骤2上一个选项
        function moveToPreviousCorrectOption() {
            currentCorrectOption--;
            
            if (currentCorrectOption < 0) {
                currentCorrectOption = 3;
                currentCorrectQuestion--;
                
                if (currentCorrectQuestion < 0) {
                    currentCorrectQuestion = 0;
                    currentCorrectOption = 0;
                }
            }
            
            updateCorrectCurrentSelection();
        }
        
        // 移动到步骤3上一个选项
        function moveToPreviousOption() {
            currentOption--;
            
            if (currentOption < 0) {
                currentOption = 3;
                currentQuestion--;
                
                if (currentQuestion < 0) {
                    currentQuestion = 0;
                    currentOption = 0;
                }
            }
            
            updateCurrentSelection();
        }
        
        // 更新答案录入进度 - 修改为只显示总题数
        function updateAnswerProgress() {
            answerProgress.textContent = `总题数: ${examData.questionCount}`;
        }
        
        // 更新学生答案录入进度
        function updateStudentProgress() {
            let currentStudent;
            if (currentStudentIndex >= 0) {
                currentStudent = studentAnswersList[currentStudentIndex];
            } else {
                if (studentAnswersList.length === 0) {
                    studentProgress.textContent = `完成进度: 0/${examData.questionCount}`;
                    return;
                }
                currentStudent = studentAnswersList[studentAnswersList.length - 1];
            }
            
            const completed = currentStudent.answers.reduce((count, question) => {
                return question.every(opt => opt !== null) ? count + 1 : count;
            }, 0);
            studentProgress.textContent = `完成进度: ${completed}/${examData.questionCount}`;
        }
        
        // 计算每道题的得分（新评分规则）
        function calculateQuestionScore(questionIndex, studentAnswer) {
            const userAnswers = studentAnswer;
            const correct = correctAnswers[questionIndex];
            let correctCount = 0;
            let unanswered = false;
            
            // 检查是否作答
            for (let j = 0; j < 4; j++) {
                if (userAnswers[j] === null) {
                    unanswered = true;
                    break;
                }
            }
            
            // 如果有未作答的选项，该题得0分
            if (unanswered) {
                return 0;
            }
            
            // 计算正确数量
            for (let j = 0; j < 4; j++) {
                // 如果教师端输入是空格（null），学生只要填涂了（非null）就正确
                if (correct[j] === null) {
                    // 学生填涂了（非null）就正确
                    correctCount++;
                } else {
                    // 教师端有明确答案（T或F），需要匹配
                    if (userAnswers[j] === correct[j]) {
                        correctCount++;
                    }
                }
            }
            
            // 根据正确数量计算得分
            if (correctCount === 4) {
                return 2;
            } else if (correctCount === 3) {
                return 1;
            } else if (correctCount === 2) {
                return 0.2;
            }
            
            return 0;
        }
        
        // 计算总分
        function calculateTotalScore(studentAnswer) {
            let totalScore = 0;
            
            for (let i = 0; i < examData.questionCount; i++) {
                totalScore += calculateQuestionScore(i, studentAnswer[i]);
            }
            
            return totalScore.toFixed(1);
        }
        
        // 更新成绩表格
        function updateResultsTable() {
            resultsBody.innerHTML = '';
            
            // 过滤掉未提交的学生记录（姓名为空的记录）
            const submittedStudents = studentAnswersList.filter(student => student.name.trim() !== '');
            
            if (submittedStudents.length === 0) {
                noDataMessage.style.display = 'block';
                resultsBody.style.display = 'none';
                downloadClassReport.disabled = true;
                return;
            }
            
            noDataMessage.style.display = 'none';
            resultsBody.style.display = 'table-row-group';
            
            // 计算每个学生的成绩
            const studentsWithScores = submittedStudents.map((student, index) => {
                return {
                    index: studentAnswersList.indexOf(student),
                    name: student.name,
                    grade: student.grade,
                    class: student.class,
                    score: parseFloat(calculateTotalScore(student.answers))
                };
            });
            
            // 按成绩排序
            studentsWithScores.sort((a, b) => b.score - a.score);
            
            // 生成表格行
            studentsWithScores.forEach((student, rank) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rank + 1}</td>
                    <td>${student.grade} ${student.class}班</td>
                    <td>${student.name}</td>
                    <td>${student.score}分</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn download-btn view-detail-btn" data-index="${student.index}">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                            <button class="action-btn edit-btn" data-index="${student.index}">
                                <i class="fas fa-edit"></i> 修改
                            </button>
                            <button class="action-btn delete-btn" data-index="${student.index}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                `;
                resultsBody.appendChild(row);
            });
            
            // 更新表格标题
            tableTitle.textContent = `${examData.id}-${examData.name} 答题情况`;
            
            // 启用下载班级报表按钮
            if (submittedStudents.length >= 2) {
                downloadClassReport.disabled = false;
            }
        }
        
        // 更新统计信息
        function updateStats() {
            // 过滤掉未提交的学生记录（姓名为空的记录）
            const submittedStudents = studentAnswersList.filter(student => student.name.trim() !== '');
            
            if (submittedStudents.length === 0) {
                statsContainer.innerHTML = '<div class="no-data">暂无数据</div>';
                return;
            }
            
            // 计算统计数据
            const scores = submittedStudents.map(student => parseFloat(calculateTotalScore(student.answers)));
            const averageScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
            const maxScore = Math.max(...scores).toFixed(1);
            const minScore = Math.min(...scores).toFixed(1);
            
            // 生成统计卡片
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">平均分</div>
                    <div class="stat-value">${averageScore}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最高分</div>
                    <div class="stat-value">${maxScore}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最低分</div>
                    <div class="stat-value">${minScore}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">学生人数</div>
                    <div class="stat-value">${submittedStudents.length}</div>
                </div>
            `;
        }
        
        // 生成单个学生得分详情CSV
        function generateStudentScoreCSV(studentIndex) {
            const student = studentAnswersList[studentIndex];
            const score = calculateTotalScore(student.answers);
            
            // CSV文件头（添加UTF-8 BOM头解决中文乱码问题）
            let csvContent = "\uFEFF题号,得分\n";
            
            // 添加每道题的得分
            for (let i = 0; i < examData.questionCount; i++) {
                const questionScore = calculateQuestionScore(i, student.answers[i]);
                csvContent += `${i + 1},${questionScore.toFixed(1)}\n`;
            }
            
            // 添加总分
            csvContent += `总分,${score}\n`;
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // 创建下载链接
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `${student.grade}${student.class}班_${student.name}_${examData.id}_答题结果.csv`);
            link.style.visibility = 'hidden';
            
            // 添加到文档并触发点击
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 生成班级报表CSV
        function generateClassReportCSV() {
            // 过滤掉未提交的学生记录（姓名为空的记录）
            const submittedStudents = studentAnswersList.filter(student => student.name.trim() !== '');
            
            // 计算每个学生的成绩
            const studentsWithScores = submittedStudents.map((student, index) => {
                return {
                    name: student.name,
                    grade: student.grade,
                    class: student.class,
                    score: parseFloat(calculateTotalScore(student.answers))
                };
            });
            
            // 按成绩排序
            studentsWithScores.sort((a, b) => b.score - a.score);
            
            // CSV文件头（添加UTF-8 BOM头解决中文乱码问题）
            let csvContent = "\uFEFF排名,姓名,年级班级,成绩\n";
            
            // 添加学生数据
            studentsWithScores.forEach((student, rank) => {
                csvContent += `${rank + 1},${student.name},${student.grade}${student.class}班,${student.score}\n`;
            });
            
            // 添加空行和统计信息
            csvContent += `\n`;
            csvContent += `平均分,${(studentsWithScores.reduce((sum, student) => sum + student.score, 0) / studentsWithScores.length).toFixed(2)}\n`;
            
            // 添加空两行
            csvContent += `\n\n`;
            
            // 添加个体作答情况表头
            csvContent += `题号,2分人数,占比(%),1分人数,占比(%),0.2分人数,占比(%),0分人数,占比(%)\n`;
            
            // 计算每道题的得分分布
            for (let i = 0; i < examData.questionCount; i++) {
                let score2Count = 0;
                let score1Count = 0;
                let score02Count = 0;
                let score0Count = 0;
                
                submittedStudents.forEach(student => {
                    const score = calculateQuestionScore(i, student.answers[i]);
                    if (score === 2) score2Count++;
                    else if (score === 1) score1Count++;
                    else if (score === 0.2) score02Count++;
                    else score0Count++;
                });
                
                const totalStudents = submittedStudents.length;
                csvContent += `${i + 1},${score2Count},${((score2Count / totalStudents) * 100).toFixed(1)}%,${score1Count},${((score1Count / totalStudents) * 100).toFixed(1)}%,${score02Count},${((score02Count / totalStudents) * 100).toFixed(1)}%,${score0Count},${((score0Count / totalStudents) * 100).toFixed(1)}%\n`;
            }
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // 创建下载链接
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `${examData.name}_${examData.id}_答题情况.csv`);
            link.style.visibility = 'hidden';
            
            // 添加到文档并触发点击
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 导出数据
        function exportData() {
            if (!isStep1Locked || !isCorrectAnswersLocked) {
                alert('至少完成步骤1和2才能导出！');
                return;
            }
            
            if (!confirm('注意：只能导出已经结分的学生成绩！')) {
                return;
            }
            
            // 准备导出的数据
            const exportData = {
                examData: examData,
                correctAnswers: correctAnswers,
                studentAnswersList: studentAnswersList,
                exportTime: new Date().toISOString()
            };
            
            // 转换为JSON字符串
            const dataString = JSON.stringify(exportData);
            
            // 生成文件名
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            const filename = `${examData.id}-${timestamp}.bu`;
            
            // 创建Blob对象
            const blob = new Blob([dataString], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            // 创建下载链接
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            
            // 添加到文档并触发点击
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('数据导出成功！');
        }
        
        // 检查是否有现有数据
        function hasExistingData() {
            return isStep1Locked || correctAnswers.length > 0 || studentAnswersList.length > 0;
        }
        
        // 导入数据
        function importData() {
            // 检查是否有现有数据
            if (hasExistingData()) {
                if (!confirm('确定导入吗？现有的所有数据将被替换。')) {
                    return;
                }
            }
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.bu';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // 验证数据完整性
                        if (!importedData.examData || !importedData.correctAnswers || !importedData.studentAnswersList) {
                            throw new Error('数据文件格式不正确');
                        }
                        
                        if (!importedData.examData.id || !importedData.examData.name || !importedData.examData.questionCount) {
                            throw new Error('试卷数据不完整');
                        }
                        
                        // 验证正确答案数据
                        if (!Array.isArray(importedData.correctAnswers) || 
                            importedData.correctAnswers.length !== importedData.examData.questionCount) {
                            throw new Error('正确答案数据不匹配');
                        }
                        
                        // 验证学生答案数据
                        if (!Array.isArray(importedData.studentAnswersList)) {
                            throw new Error('学生答案数据格式错误');
                        }
                        
                        // 加载数据
                        examData = importedData.examData;
                        correctAnswers = importedData.correctAnswers;
                        studentAnswersList = importedData.studentAnswersList;
                        
                        // 设置锁定状态
                        isStep1Locked = true;
                        isCorrectAnswersLocked = true;
                        
                        // 更新表单
                        document.getElementById('examId').value = examData.id;
                        document.getElementById('examName').value = examData.name;
                        document.getElementById('questionCount').value = examData.questionCount;
                        
                        // 锁定表单
                        lockStep1Form();
                        
                        alert('数据导入成功！');
                        
                        // 刷新当前步骤的显示
                        if (currentStep === 2) {
                            goToStep(2);
                        } else if (currentStep === 3) {
                            goToStep(3);
                        } else if (currentStep === 4) {
                            goToStep(4);
                        }
                        
                    } catch (error) {
                        alert(`导入失败，原因：${error.message}`);
                    }
                };
                
                reader.readAsText(file);
            };
            
            fileInput.click();
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加键盘事件监听
            document.addEventListener('keydown', handleKeyDown);
            
            // 步骤导航栏点击事件
            stepItems.forEach(item => {
                item.addEventListener('click', function() {
                    const step = parseInt(this.dataset.step);
                    goToStep(step);
                });
            });
            
            // 导入导出按钮事件
            document.getElementById('importData').addEventListener('click', importData);
            document.getElementById('exportData').addEventListener('click', exportData);
            
            // 步骤1：下一步按钮
            document.getElementById('nextToStep2').addEventListener('click', function() {
                const examId = document.getElementById('examId').value.trim();
                const examName = document.getElementById('examName').value.trim();
                const questionCount = parseInt(document.getElementById('questionCount').value);
                
                if (!examId || !examName) {
                    alert('请填写完整的试卷信息！');
                    return;
                }
                
                if (questionCount < 1 || questionCount > 200) {
                    alert('试题数量必须在1-200之间！');
                    return;
                }
                
                if (confirm('确定要保存试卷信息并进入下一步吗？保存后将无法修改试卷信息。')) {
                    // 保存试卷数据
                    examData = {
                        id: examId,
                        name: examName,
                        questionCount: questionCount
                    };
                    
                    // 锁定步骤1表单
                    isStep1Locked = true;
                    lockStep1Form();
                    
                    // 进入步骤2
                    goToStep(2);
                }
            });
            
            // 步骤2：上一步按钮
            document.getElementById('backToStep1').addEventListener('click', function() {
                goToStep(1);
            });
            
            // 步骤2：确认答案按钮 - 修改：不再检查是否有未设置答案
            document.getElementById('confirmAnswers').addEventListener('click', function() {
                if (confirm('确定要确认答案吗？确认后将无法修改。')) {
                    isCorrectAnswersLocked = true;
                    lockCorrectAnswers();
                }
            });
            
            // 步骤2：下一步按钮
            document.getElementById('nextToStep3').addEventListener('click', function() {
                goToStep(3);
            });
            
            // 步骤3：上一步按钮
            document.getElementById('backToStep2').addEventListener('click', function() {
                goToStep(2);
            });
            
            // 步骤3：提交学生答案按钮
            document.getElementById('submitStudent').addEventListener('click', function() {
                const name = document.getElementById('studentName').value.trim();
                const grade = document.getElementById('studentGrade').value;
                const cls = document.getElementById('studentClass').value.trim();
                
                if (!name || !grade || !cls) {
                    alert('请填写完整的学生信息！');
                    return;
                }
                
                // 保存学生答案
                if (currentStudentIndex >= 0) {
                    // 更新现有学生
                    studentAnswersList[currentStudentIndex] = {
                        name: name,
                        grade: grade,
                        class: cls,
                        answers: [...studentAnswersList[currentStudentIndex].answers]
                    };
                    alert('学生答案已更新！');
                } else {
                    // 检查是否已经有临时学生记录
                    if (studentAnswersList.length > 0 && studentAnswersList[studentAnswersList.length - 1].name === '') {
                        // 更新临时学生记录
                        studentAnswersList[studentAnswersList.length - 1] = {
                            name: name,
                            grade: grade,
                            class: cls,
                            answers: [...studentAnswersList[studentAnswersList.length - 1].answers]
                        };
                    } else {
                        // 添加新学生
                        studentAnswersList.push({
                            name: name,
                            grade: grade,
                            class: cls,
                            answers: Array(examData.questionCount).fill().map(() => Array(4).fill(null))
                        });
                    }
                    alert('学生答案已保存！');
                }
                
                // 重置表单
                document.getElementById('studentName').value = '';
                document.getElementById('studentGrade').value = '';
                document.getElementById('studentClass').value = '';
                
                // 重置UI和进度
                studentAnswerSheet.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // 重置导航
                currentQuestion = 0;
                currentOption = 0;
                currentStudentIndex = -1;
                allQuestionsAnswered = false;
                updateCurrentSelection();
                
                // 重新初始化临时学生记录
                if (studentAnswersList.length === 0 || studentAnswersList[studentAnswersList.length - 1].name !== '') {
                    studentAnswersList.push({
                        name: '',
                        grade: '',
                        class: '',
                        answers: Array(examData.questionCount).fill().map(() => Array(4).fill(null))
                    });
                }
                updateStudentProgress();
            });
            
            // 步骤3：查看结果按钮
            document.getElementById('viewResults').addEventListener('click', function() {
                goToStep(4);
            });
            
            // 步骤3：下载学生详情按钮
            downloadStudentDetail.addEventListener('click', function() {
                if (currentStudentIndex >= 0) {
                    generateStudentScoreCSV(currentStudentIndex);
                }
            });
            
            // 步骤3：返回成绩分析按钮
            backToResults.addEventListener('click', function() {
                isViewMode = false;
                currentStudentIndex = -1;
                document.getElementById('step3').classList.remove('view-mode');
                studentActions.style.display = 'flex';
                viewActions.style.display = 'none';
                
                // 重置表单
                document.getElementById('studentName').value = '';
                document.getElementById('studentGrade').value = '';
                document.getElementById('studentClass').value = '';
                
                // 重置UI
                studentAnswerSheet.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('student-correct', 'student-incorrect', 'locked');
                });
                
                goToStep(4);
            });
            
            // 步骤4：上一步按钮
            document.getElementById('backToStep3').addEventListener('click', function() {
                goToStep(3);
            });
            
            // 步骤4：下载班级报表按钮
            document.getElementById('downloadClassReport').addEventListener('click', function() {
                generateClassReportCSV();
            });
            
            // 步骤4：表格操作按钮事件委托
            document.getElementById('resultsBody').addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;
                
                const studentIndex = parseInt(target.dataset.index);
                
                if (target.classList.contains('view-detail-btn')) {
                    // 查看学生答案详情
                    isViewMode = true;
                    currentStudentIndex = studentIndex;
                    const student = studentAnswersList[studentIndex];
                    
                    // 填充表单
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentGrade').value = student.grade;
                    document.getElementById('studentClass').value = student.class;
                    
                    // 切换到只读模式
                    document.getElementById('step3').classList.add('view-mode');
                    studentActions.style.display = 'none';
                    viewActions.style.display = 'flex';
                    
                    // 进入步骤3
                    goToStep(3);
                } else if (target.classList.contains('edit-btn')) {
                    // 编辑学生答案
                    isViewMode = false;
                    currentStudentIndex = studentIndex;
                    const student = studentAnswersList[studentIndex];
                    
                    // 填充表单
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentGrade').value = student.grade;
                    document.getElementById('studentClass').value = student.class;
                    
                    // 进入步骤3
                    goToStep(3);
                } else if (target.classList.contains('delete-btn')) {
                    // 删除学生记录
                    if (confirm('确定要删除这条学生记录吗？')) {
                        studentAnswersList.splice(studentIndex, 1);
                        updateResultsTable();
                        updateStats();
                    }
                }
            });
        });
    </script>
</body>
</html>
